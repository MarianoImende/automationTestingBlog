---
date: "2024-06-12T11:13:05-04:00"
title: "Performance testing con K6"
featured_image: "/images/k6/k6.png"
date: 2024-10-25
tags: ["stress", "performance", "testing"]
description: "Guía para utilizar K6 para pruebas de Performance"
---

# Tipos de Checks en k6
En **k6**, los **checks** son aserciones que permiten validar las respuestas de tus solicitudes HTTP. A continuación, se describen los tipos comunes de checks que puedes usar:

## 1. Checks de Código de Estado
Verifica que el código de estado de la respuesta sea el esperado.

```javascript
check(res, {
    'el código de estado es 200': (r) => r.status === 200,
});

```

## Checks de Tiempo de Respuesta
Comprueba que el tiempo de respuesta esté dentro de los límites aceptables.

```javascript
check(res, {
    'el tiempo de respuesta es menor a 200ms': (r) => r.timings.duration < 200,
});

```

## 3. Checks del Cuerpo de la Respuesta
Valida contenido específico en el cuerpo de la respuesta. Útil para comprobar que los datos esperados se devuelvan.

```javascript
check(res, {
    'el cuerpo contiene "success"': (r) => r.body.includes('success'),
});

// Para respuestas JSON:
const jsonResponse = JSON.parse(res.body);
check(jsonResponse, {
    'los datos existen': (j) => j.data !== undefined,
    'el id del usuario es 1': (j) => j.user.id === 1,
});

```

## 4. Checks de Cabeceras
Verifica que ciertas cabeceras estén presentes o tengan valores esperados.

```javascript
check(res, {
    'Content-Type es application/json': (r) => r.headers['Content-Type'] === 'application/json',
});

```

## 5. Checks Combinados
Puedes combinar múltiples checks para validar completamente una respuesta.

```javascript
check(res, {
    'el código de estado es 200': (r) => r.status === 200,
    'el cuerpo contiene "success"': (r) => r.body.includes('success'),
    'Content-Type es application/json': (r) => r.headers['Content-Type'] === 'application/json',
});

```

## 6. Checks con Lógica Personalizada
Implementa lógica personalizada para validaciones más complejas.

```javascript
function validarUsuario(usuario) {
    return usuario.age > 18 && usuario.active === true;
}

check(jsonResponse, {
    'el usuario es válido': () => validarUsuario(jsonResponse),
});

```

## 7. Checks de Manejo de Errores
Valida respuestas específicas de error o códigos de estado para asegurarte de que tu aplicación falle de manera controlada.

```javascript
if (res.status === 404) {
    check(jsonResponse, {
        'el mensaje de error es correcto': (obj) => obj.error === 'Not Found',
        'el código de error es 404': (obj) => obj.code === 404,
    });
}

```

## 8. Validación de JSON Anidado
Cuando trabajes con objetos JSON profundamente anidados, verifica la estructura y el contenido.

```javascript
check(jsonResponse, {
    'los detalles del usuario son correctos': (obj) => obj.user && obj.user.id === 1 && obj.user.details.age > 18,
    'los títulos de las publicaciones están presentes': (obj) => Array.isArray(obj.posts) && obj.posts.every(post => post.title !== undefined),
});

```

## 9. Combinar Condiciones
Puedes combinar checks usando operadores lógicos.

```javascript
check(res, {
    'el código de estado es 200 y Content-Type es JSON': (r) => r.status === 200 && r.headers['Content-Type'] === 'application/json',
});

```
## 10. Validación en Bucles
Verifica múltiples elementos en un arreglo.

```javascript
const validPosts = jsonResponse.posts.filter(post => post.published);

check(validPosts, {
    'todas las publicaciones publicadas tienen títulos': () => validPosts.every(post => post.title !== undefined),
});

```

## 11. Checks con Funciones Personalizadas
Encapsula lógica compleja en funciones reutilizables.

```javascript
function esUsuarioValido(usuario) {
    return usuario && usuario.id > 0 && usuario.active === true && usuario.roles.includes('user');
}

check(jsonResponse, {
    'el usuario es válido': () => esUsuarioValido(jsonResponse.user),
});

```

## 12. Checks Condicionales
Realiza checks que dependan de resultados previos.

```javascript
let usuarioExiste = false;

if (res.status === 200) {
    const jsonResponse = JSON.parse(res.body);
    usuarioExiste = jsonResponse.user !== null;
}

check(res, {
    'el usuario existe': () => usuarioExiste,
});

```

## 13. Checks con Patrones Específicos
Valida patrones específicos (por ejemplo, formato de IDs) con expresiones regulares.

```javascript
check(jsonResponse, {
    'el ID del usuario sigue el patrón': (obj) => /^user_\d+$/.test(obj.id),
});

```

## 14. Validación de Paginación
Prueba la lógica de paginación para asegurar que las páginas devuelven los datos esperados.

```javascript
const primeraPagina = http.get('https://api.example.com/items?page=1');
const segundaPagina = http.get('https://api.example.com/items?page=2');

check(primeraPagina, {
    'la primera página tiene elementos': (r) => r.json().items.length > 0,
});

check(segundaPagina, {
    'los elementos de la segunda página son diferentes': () => {
        const primeraItems = primeraPagina.json().items;
        const segundaItems = segundaPagina.json().items;
        return !primeraItems.some(item => segundaItems.some(secondItem => secondItem.id === item.id));
    },
});

```

## 15. Métricas Agregadas
Combina métricas de rendimiento y validaciones.

```javascript
let checksTotales = 0;

check(res, {
    'el código de estado es 200': (r) => {
        const resultado = r.status === 200;
        checksTotales += resultado ? 1 : 0;
        return resultado;
    },
    'el cuerpo es válido': (r) => {
        const jsonResponse = JSON.parse(r.body);
        const resultado = jsonResponse.success === true;
        checksTotales += resultado ? 1 : 0;
        return resultado;
    },
});

console.log(`Checks totales aprobados: ${checksTotales}`);

```
